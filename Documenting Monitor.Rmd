---
title: "Documenting Monitor"
author: "Minoo"
date: "2022-11-30"
output: word_document
---

The Monitor data has been received on 18.08.2022 as zip file called Minoo, and is saved in this pathway C:\\Users\\PhysioUser\\Desktop\\PhD\\Monitor A copy of the raw signals has been saved in Monitor\\raw signals. then the signals are preprocessed and saved in 3 subfolders in Monitor\\pre-processed signals:

-   Filtered signals
-   Nirs containing transients
-   Transients

The code used to pre-process the raw NIRS signals is Monitor.m. It has been modified for each participant based on individual differences. the outcome is saved as mydata.txt.

Then transient_extraction.m has been used to extract the transients and saved files as transient and filtered.

## Transients
### Extracting features
the transient_feature_extraction.m file has been used to extract the features from the transients. The outcome is saved as transient_features_MN.  calculating_nirs_duration.m has been used to have the duration of NIRS in each participant. my_code_put_together_allfeatures.m has been used to gather all the features extracted from transients in a single .csv file called all_transient_features.csv.

### Optimization for xgboost parameters_MRI
61 infants were recruited and NIRS was measured for them, when the NIRS had been pre-processed, because some files had to be separated to two, we had 65 files. MN0052 was excluded since he had the diagnosis of sepsis, and we could not say for definite that HIE was the cause of their encephalopathy. MN0030 and MN0041 were mild that had been cooled, so they do not have MRI outcome but could be included in the HIE group. For MRI outcome, we have 58 infants, and 62 files, since 4 babies had 2 files. We have averaged the values except for the time spent below 63%, which was added, and we have 58 rows in total. 

Then a leave-one-out method optimization has been done to find the best values for xgboost method. the python code used is optimization.IPYNB. The transient features are saved as *transient for xgb_MRI.csv* which is colab-friendly! The result is saved in optimization_transient_xgb.csv. The outcome used is *Composite outcome of barkovich MRI abnormality +/- death (0=normal, 1=abnormal)* which has been in the file called  MRI outcome for xgb_58ver.csv. The optimized values are highlighted in yellow. 

### leave one out xgboost_MRI
The code called transient_xgboost.IPYNB is used for the leave one out xgboost method.the files used for this purpose are MRI outcome for xgb_58ver.csv and transient for xgb_MRI.csv. Then the matlab code auc_CI_sen_spec.m has been used to calculate the 95% confidence interval of AUC, accuracy, sensitivity and specificity:  
```{r monitor probabilities and AUC, echo=FALSE, include=FALSE}
monitor_prob_auc <- readxl::read_excel("Monitor_probabilities_AUC.xlsx")
```

```{r tran auc, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61:65,1:2], digits =  4, 
             caption = "The AUC for transients with MRI outcome")
```


### MRI watershed outcome
We used the same parameters as MRI, the files transient for xgb_MRI.csv, watershed outcome for xgb.58ver.csv, and transient_xgboost.IPYNB, and the AUC was:

```{r, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61:65,c(1,9)], digits =  4, 
             caption = "The AUC for transients with MRI_watershed outcome")
```

### MRI gray injury outcome
We used the same parameters as MRI, the files transient for xgb_MRI.csv, gray injury outcome for xgb.58ver.csv, and transient_xgboost.IPYNB, and the AUC was:

```{r, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61:65,c(1,8)], digits =  4, 
             caption = "The AUC for transients with MRI_gray injury outcome")
```

### Optimization for xgboost parameters_HIE
61 infants were recruited and NIRS was measured for them, when the NIRS had been pre-processed, because some files had to be separated to two, we had 65 files. MN0052 was excluded since he had the diagnosis of sepsis, and we could not say for definite that HIE was the cause of their encephalopathy. MN0030 and MN0041 were mild that had been cooled, and were included in the HIE group with non-injury label. For HIE outcome, we have 60 infants in total, some files are separated,so we have 64 files, but at the end the features are added and averaged for babies with more than one file and we have 60 rows at the end. 

Then a leave-one-out method optimization has been done to find the best values for xgboost method. the python code used is optimization.IPYNB. The transient features are saved as *transient for xgb_HIE.csv* which is colab-friendly! The result is saved in optimization_transient_HIE_xgb.csv. The outcome used is *Clinical Grade of HIE (0=mild, 1=moderate or severe)* which has been in the file called  HIE outcome for xgb_60ver.csv. The optimized values are highlighted in yellow. 

### leave one out xgboost_HIE
The code called transient_xgboost.IPYNB is used for the leave one out xgboost method.the files used for this purpose are HIE outcome for xgb_60ver.csv and and transient for xgb_HIE.csv. the AUC is significant: 

```{r tran auc HIE, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61:65,c(1,3)], digits =  4, 
             caption = "The AUC for transients with HIE outcome")
```


In the next level, we were wondering if the features extracted from the transients could predict the HIE level, so we used the same files, just in the HIE outcome for xgb_60ver, instead of column 2, we used the HIE levels in column 3. for optimization and training the model, we used multiclass_xgboost.ipynb python file. The optimized parameters are saved in optimization_transient_HIE_grading.xlsx and the chosen parameters are highlighted in yellow. 

Then, using the R code called "multiclass_auc&ci", and the probabilities saved in the file multiclass_prob.xlsx, we calculated the AUC and 95% confidence interval. 

```{r, echo=FALSE, include=FALSE}
multiclass <- readxl::read_excel("Monitor_probabilities_AUC.xlsx", sheet = "multiclass")

```

```{r, echo=FALSE, include=TRUE}
knitr::kable(multiclass[1:3, c(1,2)], digits =  4, 
             caption = "The AUC and 95% CI for transient with HIE grading outcome")
```

### transient first 6 hours
The transients were separated for the first 6 hours after starting of recording, and the features were extracted from them. They had been saved in transient for xgb_MRI_6h.csv and transient for xgb_HIE_6h.csv, and then using MRI outcome for xgb_58ver.csv and HIE outcome for xgb_60ver.csv, they had been optimized. The optimizations are saved as optimization_transient_6h_MRI, optimization_transient_6h_HIE_xgb and optimization_transient_6h_HIE_grading, and the optimized values are highlighted in yellow. The results are as followed:

```{r, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61:65,c(1,14,15)], digits =  4, 
             caption = "The AUC for transients in first 6 hours")
```

```{r, echo=FALSE, include=TRUE}
knitr::kable(multiclass[1:3, c(1,5)], digits =  4, 
             caption = "The AUC and 95% CI for transient in first 6 hours")
```

## NIRS signal containing tarnsients
### Extracting features
the nirs_feature_extraction.m file has been used to decompose the signal into 5 bandwidths, divide them into epochs of 4 hours with 2 hours of overlapping and extract the features from each epoch in each bandwidth of the NIRS signal that still contains transients. The outcome is saved as nirs_features_MN. The extracted features are: 

- mean envelope (*5)
- standard deviation envelope (*5)
- signal kurtosis (*5)
- signal skewness (*5)
- 5th percentile of envelope (*5)
- 95th percentile of envelope (*5)
- mean instantaneous frequency (*5)
- standard deviation instantaneous frequency (*5)
- kurtosis instantaneous frequency (*5)
- skewness instantaneous frequency (*5)
- 5th percentile instantaneous frequency (*5)
- 95th percentile instantaneous frequency (*5)
- fractal dimension (*5)
- the energy of signal in 5th percentile of the signal duration
- the energy of signal in 95th percentile of the signal duration

This gives us 67 features in total, but we will not include the energy of the signal in the 5th and 95th percentile of the signal duration. 

my_code_put_together_allfeatures_nirs.m has been used to gather all the features extracted from NIRS in a single .csv file called all_nirs_features.csv.

### Optimization for NIRS xgboost parameters_MRI
Same as what was explained in *optimization for xgboost parameters_MRI*, we had 62 files at the end.Since each NIRS recording has different duration, we had different number of epochs for each infant. the colab friendly file containing the info for these 62 files is saved as *nirs with MRI outcome for xgb*. it is a 1505*66 matrix. The first column contains the IDs and columns 2-66 correspond to the 65 features for each epoch. The outcome is saved as MRI outcome for xgb_nirs.csv.

Then a leave-one-out method optimization has been done to find the best values for xgboost method. the python code used is optimization.IPYNB. MRI outcome for xgb_58ver.csv has been used for getting AUC. The optimized values are saved in optimization_nirs_MRI_xgb.xlsx and the chosen values are highlighted in yellow. 

### leave one out xgboost_MRI_NIRS
The code called transient_xgboost.IPYNB is used for the leave one out xgboost method.the files used for this purpose are nirs with MRI outcome for xgb.csv, MRI outcome for xgb_nirs.csv and MRI outcome for xgb_58ver.csv (the last one used for getting AUC). The AUC is significant: 

```{r nirs auc, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61:65,c(1,4)], digits =  4, 
             caption = "The AUC for NIRS with MRI outcome")
```

### MRI watershed outcome
with not optimized parameters, the files nirs with MRI ourcome for xgb_MRI.csv, watershed outcome for xgb_nirs.csv, and transient_xgboost.IPYNB, the AUC was:

```{r, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61:65,c(1,11)], digits =  4, 
             caption = "The AUC for NIRS with MRI_watershed outcome")
```

### MRI gray injury outcome
with not optimized parameters, the files nirs with MRI ourcome for xgb_MRI.csv, gray injury outcome for xgb_nirs.csv, and transient_xgboost.IPYNB, the AUC was:

```{r, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61:65,c(1,10)], digits =  4, 
             caption = "The AUC for NIRS with MRI_gray injury outcome")
```

### Optimization for NIRS xgboost parameters_HIE
Same as what was explained in *optimization for xgboost parameters_HIE*, we had 64 files at the end.Since each NIRS recording has different duration, we had different number of epochs for each infant. the colab friendly file containing the info for these 64 files is saved as *nirs with HIE outcome for xgb*. it is a 1549*66 matrix. The first column contains the IDs and columns 2-66 correspond to the 65 features for each epoch. The outcome is saved as HIE outcome for xgb_nirs.csv.

Then a leave-one-out method optimization has been done to find the best values for xgboost method. the python code used is optimization.IPYNB. HIE outcome for xgb_60ver.csv has been used for getting AUC. The optimized values are saved as optimization_nirs_HIE_xgb.xlsx and chosen parameters are highlighted in yellow. 

### leave one out xgboost_HIE_NIRS
The code called transient_xgboost.IPYNB is used for the leave one out xgboost method.the files used for this purpose are nirs with HIE outcome for xgb.csv, HIE outcome for xgb_nirs.csv and HIE outcome for xgb_60ver.csv (the last one used for getting AUC). The AUC is significant: 

```{r, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61:65,c(1,5)], digits =  4, 
             caption = "The AUC for NIRS with HIE outcome")
```


In the next level, we were wondering if the features extracted from the NIRS could predict the HIE level, so we used the same files, just in the HIE outcome for xgb_nirs, instead of column 2, we used the HIE levels in column 3. for optimization and training the model, we used multiclass_xgboost.ipynb python file. The optimized parameters are saved in optimization_nirs_HIE_grading.xlsx and the chosen parameters are highlighted in yellow. 

Then, using the R code called "multiclass_auc&ci", and the probabilities saved in the file multiclass_prob.xlsx, we calculated the AUC and 95% confidence interval. 


```{r, echo=FALSE, include=TRUE}
knitr::kable(multiclass[1:3, c(1,3)], digits =  4, 
             caption = "The AUC and 95% CI for nirs with HIE grading outcome")
```


### NIRS first 6 hours
The NIRS were separated for the first 6 hours after starting of recording (the first 2 epochs). They had been saved in nirs with MRI outcome for xgb_6h.csv and nirs with HIE outcome for xgb_6h.csv, and then using MRI outcome for xgb_58ver.csv, HIE outcome for xgb_60ver.csv, MRI outcome for xgb_nirs_6h, and HIE outcome for xgb_nirs_6h, they had been optimized. The optimizations are saved as optimization_nirs_6h_MRI, optimization_nirs_6h_HIE_xgb and optimization_nirs_6h_HIE_grading, and the optimized values are highlighted in yellow. The results are as followed:

```{r, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61:65,c(1,16,17)], digits =  4, 
             caption = "The AUC for nirs in first 6 hours")
```

```{r, echo=FALSE, include=TRUE}
knitr::kable(multiclass[1:3, c(1,6)], digits =  4, 
             caption = "The AUC and 95% CI for nirs in first 6 hours")
```


## Filtered NIRS signal

### Extracting features
the nirs_feature_extraction.m file has been used to decompose the signal into 5 bandwidths, divide them into epochs of 4 hours with 2 hours of overlapping and extract the features from each epoch in each bandwidth of the Filtered signal. The outcome is saved as filtered_features_MN.txt. The extracted features same as extracted features from the NIRS signals containing transients. The code my_code_put_together_allfeatures_nirs.m has been used to put all the features in a single file called all_filtered_features.csv. 

### Optimization for filteted xgboost parameters_MRI
Same as what was explained in *optimization for xgboost parameters_MRI*, we had 62 files at the end.Since each NIRS recording has different duration, we had different number of epochs for each infant. the colab friendly file containing the info for these 62 files is saved as *filtered with MRI outcome for xgb*. it is a 1505*66 matrix. The first column contains the IDs and columns 2-66 correspond to the 65 features for each epoch. The outcome is saved as MRI outcome for xgb_nirs.csv.

Then a leave-one-out method optimization has been done to find the best values for xgboost method. the python code used is optimization.IPYNB. MRI outcome for xgb_58ver.csv has been used for getting AUC. The optimized values are saved in optimization_filtered_MRI_xgb.xlsx and the chosen values are highlighted in yellow. 

### Leave one out xgboost_MRI_filtered

For the MRI outcome, and using the same code transient_xgboost.IPYNB, and the files called filtered with MRI outcome for xgb.csv, MRI outcome for xgb_nirs.csv and MRI outcome for xgb_58ver.csv have been used for training and testing the model, and this is the result: 

```{r, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61:65,c(1,6)], digits =  4, 
             caption = "The AUC for Filtered with MRI outcome")
```

### MRI watershed outcome
with not optimized parameters, the files filtered with MRI ourcome for xgb_MRI.csv, watershed outcome for xgb_nirs.csv, and transient_xgboost.IPYNB, the AUC was:

```{r, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61:65,c(1,13)], digits =  4, 
             caption = "The AUC for filtered with MRI_watershed outcome")
```

### MRI gray injury outcome
with not optimized parameters, the files filtered with MRI ourcome for xgb_MRI.csv, gray injury outcome for xgb_nirs.csv, and transient_xgboost.IPYNB, the AUC was:

```{r, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61:65,c(1,12)], digits =  4, 
             caption = "The AUC for filtered with MRI_gray injury outcome")
```

### Optimization for filtered xgboost parameters_HIE
Same as what was explained in *optimization for xgboost parameters_HIE*, we had 64 files at the end.Since each NIRS recording has different duration, we had different number of epochs for each infant. the colab friendly file containing the info for these 64 files is saved as *filtered with HIE outcome for xgb*. it is a 1549*66 matrix. The first column contains the IDs and columns 2-66 correspond to the 65 features for each epoch. The outcome is saved as HIE outcome for xgb_nirs.csv.

Then a leave-one-out method optimization has been done to find the best values for xgboost method. the python code used is optimization.IPYNB. HIE outcome for xgb_nirs.csv has been used for getting AUC. The optimized values are saved as optimization_filtered_HIE_xgb.xlsx and chosen parameters are highlighted in yellow. 

### Leave one out xgboost_HIE_filtered
for the HIE outcome, and using the same code transient_xgboost.IPYNB, and the files called filtered with HIE outcome for xgb.csv, HIE outcome for xgb_nirs.csv and HIE outcome for xgb_60ver.csv have been used for training and testing the model, and this is the result: 

```{r, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61:65,c(1,7)], digits =  4, 
             caption = "The AUC for Filtered with HIE outcome")
```

In the next level, we were wondering if the features extracted from the filtered could predict the HIE level, so we used the same files, just in the HIE outcome for xgb_nirs, instead of column 2, we used the HIE levels in column 3. for optimization and training the model, we used multiclass_xgboost.ipynb python file. The optimized parameters are saved in optimization_filtered_HIE_grading.xlsx and the chosen parameters are highlighted in yellow. 

Then, using the R code called "multiclass_auc&ci", and the probabilities saved in the file multiclass_prob.xlsx, we calculated the AUC and 95% confidence interval. 


```{r, echo=FALSE, include=TRUE}
knitr::kable(multiclass[1:3, c(1,4)], digits =  4, 
             caption = "The AUC and 95% CI for filtered with HIE grading outcome")
```

### Filtered first 6 hours
The filtered signals were separated for the first 6 hours after starting of recording (the first 2 epochs). They had been saved in filtered with MRI outcome for xgb_6h.csv and filtered with HIE outcome for xgb_6h.csv, and then using MRI outcome for xgb_58ver.csv, HIE outcome for xgb_60ver.csv, MRI outcome for xgb_nirs_6h, and HIE outcome for xgb_nirs_6h, they had been optimized. The optimizations are saved as optimization_filtered_6h_MRI, optimization_filtered_6h_HIE_xgb and optimization_filtered_6h_HIE_grading, and the optimized values are highlighted in yellow. The results are as followed:

```{r, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61:65,c(1,18,19)], digits =  4, 
             caption = "The AUC for filtered in first 6 hours")
```

```{r, echo=FALSE, include=TRUE}
knitr::kable(multiclass[1:3, c(1,7)], digits =  4, 
             caption = "The AUC and 95% CI for nirs in first 6 hours")
```

## PAS 2023 abstract 
For PAS 2023 abstract, John and Gene suggested that we do not need to know if the NIRS can predict if the babies underwent cooling (0 as level I and 1 as levels II and III) or even the Hie grading. So we focused if the signals (not even the transients were focused in this abstract) were predictive of MRI abnormalities, and also if this model was working better than HIE grading, and cooling. So we made HIE grade and TH_58ver.csv, which the first column is ID, the second is HIE grading, and the third is cooling data, and using the auc_CI_sen_spec.m, we calculated the AUC of the HIE grading model, AUC = 0.6625; aauc_ci = 0.506 - 0.807). The AUC of the cooling data was 0.608; CI = 0.475  - 0.748). The model based on NIRS and filtered NIRS were performing better: AUC = 0.699, CI = 0.551 - 0.824 and AUC = 0.722, CI = 0.579 - 0.849 respectively. Just to test, we added the HIE grading and if the infants were cooled to the NIRS and filtered models to see if the performance has improved in the files called *nirs with MRI outcome for xgb_TH_HIEgrade.csv* and *filtered with MRI outcome for xgb_TH_HIEgrade.csv* and they were optimized in the files called optimization_nirs_MRI_withTH&HIEgrade.xlsx and optimization_filtered_MRI_withTH&HIEgrade.xlsx. The performance did not improve at all, even the AUC decreased a little bit. 

Also John suggested to not include the first 6 hours analysis, since we first should be sure that the it is 6 hours after birth, not after the starting of the nirs recordings. 









