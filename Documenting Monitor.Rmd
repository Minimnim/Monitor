---
title: "Documenting Monitor"
author: "Minoo"
date: "2022-11-30"
output: word_document
---

The Monitor data has been received on 18.08.2022 as zip file called Minoo, and is saved in this pathway C:\\Users\\PhysioUser\\Desktop\\PhD\\Monitor A copy of the raw signals has been saved in Monitor\\raw signals. then the signals are preprocessed and saved in 3 subfolders in Monitor\\pre-processed signals:

-   Filtered signals
-   Nirs containing transients
-   Transients

The code used to pre-process the raw NIRS signals is Monitor.m. It has been modified for each participant based on individual differences. the outcome is saved as mydata.txt.

Then transient_extraction.m has been used to extract the transients and saved files as transient and filtered.

## Transients
### Extracting features
the transient_feature_extraction.m file has been used to extract the features from the transients. The outcome is saved as transient_features_MN. The code transient_feature_extraction_below63.m is used to calculate the time rcSO2 signal is spending below 63%, and transient_features_extraction_below63_transient.m has been used to calculate the time transient signal is spending below 63%. calculating_nirs_duration.m has been used to have the duration of NIRS in each participant. my_code_put_together_allfeatures.m has been used to gather all the features extracted from transients in a single .csv file called all.csv.

```{r all_feature, echo=FALSE, include=FALSE}
transient_all <- readxl::read_excel("all.xlsx")

```

```{r table, echo=FALSE, include=FALSE}
knitr::kable(transient_all, digits =  4, 
             caption = "The features extracted from transients in all participants")
```

 
### Optimization for xgboost parameters_MRI
61 infants were recruited and NIRS was measured for them, when the NIRS had been pre-processed, because some files had to be separated to two, we had 65 files. MN0052 was excluded since he had the diagnosis of sepsis, and we could not say for definite that HIE was the cause of their encephalopathy. MN0030 and MN0041 were mild that had been cooled, so they do not have MRI outcome but could be included in the HIE group. For MRI outcome, we have 58 infants in total, and since some files are seperated, 65-3 = **62** files.

Then a leave-one-out method optimization has been done to find the best values for xgboost method. the python code used is optimization.IPYNB. The transient features are saved as *transient for xgb_MRI.csv* which is colab-friendly! The result is saved in optimization_transient_xgb.csv. The outcome used is *Composite outcome of barkovich MRI abnormality +/- death (0=normal, 1=abnormal)* which has been in the file called  MRI outcome for xgb_62ver.csv and MRI outcome for xgb_58ver.csv (the last one used for getting AUC). The optimized values are:

```{r MRI optimization, echo=FALSE, include=FALSE}
MRI_optimization <- readxl::read_excel("optimazation_transient_xgb.xlsx")

```

```{r optimized parameters for MRI, echo=FALSE, include=TRUE}
knitr::kable(MRI_optimization[1,], digits =  4, 
             caption = "The optimized parameters for XGBoost with MRI outcome")
```

### leave one out xgboost_MRI
The code called transient_xgboost.IPYNB is used for the leave one out xgboost method.the files used for this purpose are MRI outcome for xgb_62ver.csv, MRI outcome for xgb_58ver.csv (the last one used for getting AUC), and transient for xgb_MRI.csv. the AUC is not significant: 
```{r monitor probabilities and AUC, echo=FALSE, include=FALSE}
monitor_prob_auc <- readxl::read_excel("Monitor_probabilities_AUC.xlsx")
```

```{r tran auc, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61,2], digits =  4, 
             caption = "The AUC for transients with MRI outcome")
```

To be sure about the used parameters, we take another set of them to see if there is any difference in AUC or not, so we have: 

```{r another optimized parameters for MRT, echo=FALSE, include=TRUE}
knitr::kable(MRI_optimization[4,], digits =  4, 
             caption = "The optimized parameters for XGBoost with MRI outcome")
```

Using different parameters, but the same code and files, still the AUC was not significant: 

```{r another tran auc, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61,3], digits =  4, 
             caption = "The AUC for transients with MRI outcome")
```

### Optimization for xgboost parameters_HIE
61 infants were recruited and NIRS was measured for them, when the NIRS had been pre-processed, because some files had to be separated to two, we had 65 files. MN0052 was excluded since he had the diagnosis of sepsis, and we could not say for definite that HIE was the cause of their encephalopathy. MN0030 and MN0041 were mild that had been cooled, and were included in the HIE group with non-injury label. For HIE outcome, we have 60 infants in total, and since some files are seperated, 65-1 = **64** files.

Then a leave-one-out method optimization has been done to find the best values for xgboost method. the python code used is optimization.IPYNB. The transient features are saved as *transient for xgb_HIE.csv* which is colab-friendly! The result is saved in optimization_transient_HIE_xgb.csv. The outcome used is *Clinical Grade of HIE (0=mild, 1=moderate or severe)* which has been in the file called  HIE outcome for xgb_64ver.csv and HIE outcome for xgb_60ver.csv (the last one used for getting AUC). The optimized values are:

```{r HIE optimization, echo=FALSE, include=FALSE}
HIE_optimization <- readxl::read_excel("optimization_transient_HIE_xgb.xlsx")

```

```{r optimized parameters for HIE, echo=FALSE, include=TRUE}
knitr::kable(HIE_optimization[1,], digits =  4, 
             caption = "The optimized parameters for XGBoost with HIE outcome")
```

### leave one out xgboost_HIE
The code called transient_xgboost.IPYNB is used for the leave one out xgboost method.the files used for this purpose are HIE outcome for xgb_64ver.csv, HIE outcome for xgb_60ver.csv (the last one used for getting AUC), and transient for xgb_HIE.csv. the AUC is significant: 

```{r tran auc HIE, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61,4], digits =  4, 
             caption = "The AUC for transients with HIE outcome")
```

To be sure about the used parameters, we take another set of them to see if there is any difference in AUC or not, so we have: 

```{r another optimized parameters for HIE, echo=FALSE, include=TRUE}
knitr::kable(HIE_optimization[24,], digits =  4, 
             caption = "The optimized parameters for XGBoost with HIE outcome")
```

Using different parameters, but the same code and files, still the AUC was significant: 

```{r another tran auc HIE, echo=FALSE, include=TRUE}
knitr::kable(monitor_prob_auc[61,5], digits =  4, 
             caption = "The AUC for transients with HIE outcome")
```

## NIRS signal containing tarnsients
### Extracting features
the nirs_feature_extraction.m file has been used to decompose the signal into 5 bandwidths, divide them into epochs of 4 hours with 2 hours of overlapping and extract the features from each epoch in each bandwidth of the NIRS signal that still contains transients. The outcome is saved as nirs_features_MN. The extracted features are: 

- mean envelope (*5)
- standard deviation envelope (*5)
- signal kurtosis (*5)
- signal skewness (*5)
- 5th percentile of envelope (*5)
- 95th percentile of envelope (*5)
- mean instantaneous frequency (*5)
- standard deviation instantaneous frequency (*5)
- kurtosis instantaneous frequency (*5)
- skewness instantaneous frequency (*5)
- 5th percentile instantaneous frequency (*5)
- 95th percentile instantaneous frequency (*5)
- fractal dimension (*5)
- the energy of signal in 5th percentile of the signal duration
- the energy of signal in 95th percentile of the signal duration

This gives us 67 features in total, but we will not include the energy of the signal in the 5th and 95th percentile of the signal duration. 

my_code_put_together_allfeatures.m has been used to gather all the features extracted from transients in a single .csv file called all_nirs_features.csv.

### Optimization for NIRS xgboost parameters_MRI
Same as what was explained in *optimization for xgboost parameters_MRI*, we had 62 files at the end.Since each NIRS recording has different duration, we had different number of epochs for each infant. the colab friendly file containing the info for these 62 files is saved as *nirs with MRI outcome for xgb*. it is a 1505*66 matrix. The first column contains the IDs and columns 2-66 correspond to the 65 features for each epoch. The outcome is saved as MRI outcome for xgb_nirs.csv.

Then a leave-one-out method optimization has been done to find the best values for xgboost method. the python code used is optimization.IPYNB. MRI outcome for xgb_58ver.csv has been used for getting AUC. The optimized values are:
